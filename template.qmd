---
title: "Project 1"
subtitle: Precipitation Downscaling
jupyter: julia-1.9
date: 2023-11-13
author: Riley Becker (rb111)
---

# 1. Intro
```{julia}
import Pkg; Pkg.add("MultivariateStats")
import Pkg; Pkg.add("Plots")
import Pkg; Pkg.add("NCDatasets")
import Pkg; Pkg.add("StatsBase")
import Pkg; Pkg.add("Unitful")
```
```{julia}
import Pkg; Pkg.add("DataFrames")
```
```{julia}
using Dates
using MultivariateStats
using Plots
using NCDatasets
using StatsBase
using Unitful
using DataFrames
Plots.default(; margin=4Plots.mm, size=(700, 400), linewidth=2)
```
# 2. Data
## 2.1. Precipitation Data
```{julia}
precip_ds = NCDataset("data/raw/precip_tx.nc") #loading in the precip_tx.nc dataset
```
```{julia}
# Here, I'm creating variables from the precip_tx.nc dataset.
precip_time = precip_ds["time"][11324:15341] #saving the time data from 2010 through 2020
precip_time = Date.(precip_time)
precip_lon = precip_ds["lon"][:]
precip_lat = precip_ds["lat"][:]
precip_lat = reverse(precip_lat) #The latitude needs to be reversed.
precip = (precip_ds["precip"][:, :,11324:15341])*.1u"mm" #this precipitation data is in millimeters, so I'm adding in units.
precip = reverse(precip, dims=2) #Because we reversed the latitude, we need to do the same in the second dimension of the precipitation data.

display(precip_ds[:precip])
```
```{julia}
close(precip_ds) #closing the dataset
```
```{julia}
heatmap(precip_lon, precip_lat, precip[:,:,1]';xlabel="Longitude", ylabel="Latitude", title="Preipitation on $(precip_time[1])")
```


## 2.2 Temperature Data

### Loading in Temperature Data Year by Year
```{julia}
temp10_ds = NCDataset("data/raw/2m_temperature_2010.nc") 
```
```{julia}
# Here, I'm creating variables from the 2m_temperature_2010.nc dataset.
temp10_time = temp10_ds["time"]
temp10_time = Date.(temp10_time)
temp10_lon = temp10_ds["longitude"][:]
temp10_lat = temp10_ds["latitude"][:]
temp10_lat = reverse(temp10_lat) #The latitude needs to be reversed.
temp10 = (temp10_ds["t2m"][:, :,:])*.1u"K" #this temp data is in Kelvin, so I'm adding in units.
temp10 = reverse(temp10, dims=2) #Because we reversed the latitude, we need to do the same in the second dimension of the temperature data.
```
```{julia}
close(temp10_ds)
```

### Repeating this step for temp datasets from 2011 to 2020
```{julia}
temp11_ds = NCDataset("data/raw/2m_temperature_2011.nc") 
```
```{julia}

temp11_time = temp11_ds["time"]
temp11_time = Date.(temp11_time)
temp11_lon = temp11_ds["longitude"][:]
temp11_lat = temp11_ds["latitude"][:]
temp11_lat = reverse(temp11_lat) 
temp11 = (temp11_ds["t2m"][:, :,:])*.1u"K" 
temp11 = reverse(temp11, dims=2)
```
```{julia}
close(temp11_ds)
```


```{julia}
temp12_ds = NCDataset("data/raw/2m_temperature_2012.nc") 
```
```{julia}
temp12_time = temp12_ds["time"]
temp12_time = Date.(temp12_time)
temp12_lon = temp12_ds["longitude"][:]
temp12_lat = temp12_ds["latitude"][:]
temp12_lat = reverse(temp12_lat) 
temp12 = (temp12_ds["t2m"][:, :,:])*.1u"K" 
temp12 = reverse(temp12, dims=2) 
```
```{julia}
close(temp12_ds)
```


```{julia}
temp13_ds = NCDataset("data/raw/2m_temperature_2013.nc") 
```
```{julia}

temp13_time = temp13_ds["time"]
temp13_time = Date.(temp13_time)
temp13_lon = temp13_ds["longitude"][:]
temp13_lat = temp13_ds["latitude"][:]
temp13_lat = reverse(temp13_lat)
temp13 = (temp13_ds["t2m"][:, :,:])*.1u"K" 
temp13 = reverse(temp13, dims=2)
```
```{julia}
close(temp13_ds)
```


```{julia}
temp14_ds = NCDataset("data/raw/2m_temperature_2014.nc") 
```
```{julia}
temp14_time = temp14_ds["time"]
temp14_time = Date.(temp14_time)
temp14_lon = temp14_ds["longitude"][:]
temp14_lat = temp14_ds["latitude"][:]
temp14_lat = reverse(temp14_lat) 
temp14 = (temp14_ds["t2m"][:, :,:])*.1u"K" 
temp14 = reverse(temp14, dims=2) 
```
```{julia}
close(temp14_ds)
```


```{julia}
temp15_ds = NCDataset("data/raw/2m_temperature_2015.nc") 
```
```{julia}
temp15_time = temp15_ds["time"]
temp15_time = Date.(temp15_time)
temp15_lon = temp15_ds["longitude"][:]
temp15_lat = temp15_ds["latitude"][:]
temp15_lat = reverse(temp15_lat) 
temp15 = (temp15_ds["t2m"][:, :,:])*.1u"K" 
temp15 = reverse(temp15, dims=2) 
```
```{julia}
close(temp15_ds)
```


```{julia}
temp16_ds = NCDataset("data/raw/2m_temperature_2016.nc") 
```
```{julia}

temp16_time = temp16_ds["time"]
temp16_time = Date.(temp16_time)
temp16_lon = temp16_ds["longitude"][:]
temp16_lat = temp16_ds["latitude"][:]
temp16_lat = reverse(temp16_lat) 
temp16 = (temp16_ds["t2m"][:, :,:])*.1u"K" 
temp16 = reverse(temp16, dims=2) 
```
```{julia}
close(temp16_ds)
```

```{julia}
temp17_ds = NCDataset("data/raw/2m_temperature_2017.nc") 
```
```{julia}

temp17_time = temp17_ds["time"]
temp17_time = Date.(temp17_time)
temp17_lon = temp17_ds["longitude"][:]
temp17_lat = temp17_ds["latitude"][:]
temp17_lat = reverse(temp17_lat) 
temp17 = (temp17_ds["t2m"][:, :,:])*.1u"K" 
temp17 = reverse(temp17, dims=2)
```
```{julia}
close(temp17_ds)
```


```{julia}
temp18_ds = NCDataset("data/raw/2m_temperature_2018.nc") 
```
```{julia}
temp18_time = temp18_ds["time"]
temp18_time = Date.(temp18_time)
temp18_lon = temp18_ds["longitude"][:]
temp18_lat = temp18_ds["latitude"][:]
temp18_lat = reverse(temp18_lat) 
temp18 = (temp18_ds["t2m"][:, :,:])*.1u"K" 
temp18 = reverse(temp18, dims=2)
```
```{julia}
close(temp18_ds)
```

```{julia}
temp19_ds = NCDataset("data/raw/2m_temperature_2019.nc") 
```
```{julia}
temp19_time = temp19_ds["time"]
temp19_time = Date.(temp19_time)
temp19_lon = temp19_ds["longitude"][:]
temp19_lat = temp19_ds["latitude"][:]
temp19_lat = reverse(temp19_lat)
temp19 = (temp19_ds["t2m"][:, :,:])*.1u"K" 
temp19 = reverse(temp19, dims=2)
```
```{julia}
close(temp19_ds)
```


```{julia}
temp20_ds = NCDataset("data/raw/2m_temperature_2020.nc") 
```
```{julia}

temp20_time = temp20_ds["time"]
temp20_time = Date.(temp20_time)
temp20_lon = temp20_ds["longitude"][:]
temp20_lat = temp20_ds["latitude"][:]
temp20_lat = reverse(temp20_lat) 
temp20 = (temp20_ds["t2m"][:, :,:])*.1u"K" 
temp20 = reverse(temp20, dims=2)
```
```{julia}
close(temp20_ds)
```

## 2.3 Creating One Large Dataset That Combines all Temp Dat & Converting Times to Daily Instead of Hourly

```{julia}
# Function to read temperature data for a given year
function read_temperature_data(year)
    ds = NCDataset("data/raw/2m_temperature_$(year).nc")
    
    time = Date.(ds["time"])
    lon = ds["longitude"][:]
    lat = reverse(ds["latitude"][:])
    temp = (ds["t2m"][:, :, :]) * 0.1u"K"
    temp = reverse(temp, dims=2)
    
    close(ds)
    
    return time, lon, lat, temp
end

# Function to aggregate hourly data to daily data
function aggregate_to_daily(time, temp)
    unique_dates = unique(time)
    daily_temp = []

    for date in unique_dates
        indices = findall(x -> x == date, time)
        daily_mean = mean(temp[:, :, indices], dims=3)
        push!(daily_temp, daily_mean)
    end

    return unique_dates, cat(daily_temp..., dims=3)
end

# Years to process
years = 2010:2020

# Initialize arrays to store aggregated data
all_aggregated_times = []
all_aggregated_temps = []

# Loop over years and read/aggregate data
for year in years
    time, _, _, temp = read_temperature_data(year)
    aggregated_times, aggregated_temp = aggregate_to_daily(time, temp)
    
    push!(all_aggregated_times, aggregated_times)
    push!(all_aggregated_temps, aggregated_temp)
end

# Combine aggregated data
combined_aggregated_times = cat(all_aggregated_times..., dims=1)
combined_aggregated_temps = cat(all_aggregated_temps..., dims=3)
```

## 2.4 Establishing Temperature Variables

```{julia}
temp_lat = temp10_lat #All of the lat data from the different temp datasets are the same, so I represent the lat for the whole temp data just as one of lat variables I made earlier
temp_lon = temp10_lon #All of the lon data from the different temp datasets are the same, so I represent the lon for the whole temp data just as one of lon variables I made earlier
temp_time = combined_aggregated_times
temp = combined_aggregated_temps
```
```{julia}
heatmap(temp_lon, temp_lat, temp[:,:,1]'; xlabel="Longitude", ylabel="Latitude", title="Temperature on $(temp_time[1])")
```
```{julia}
@assert temp_time == precip_time
```

# 3. Splitting Data into Testing & Training data
```{julia}
test_start_date = Date(2017, 09, 13) #Splitting the test and training data 70%-30%
test_start_index = searchsortedfirst(temp_time, test_start_date)
```
```{julia}
# Here I'm splitting my data into training & testing sets

precip_train = precip[:, :, 1:test_start_index - 1]
precip_test = precip[:, :, test_start_index:end]

temp_train = temp[:, :, 1:test_start_index - 1]
temp_test = temp[:, :, test_start_index:end]

time_train = temp_time[1:test_start_index - 1]
time_test = temp_time[test_start_index:end]
```

# 4. Preprocessing
```{julia}
# ADD IN EXPLANATION AS TO WHAT IM PREPROCESSING & WHY

function preprocess(temp::Array{T,3}, temp_ref::Array{T,3})::AbstractMatrix where {T}
    n_lon, n_lat, n_t = size(temp)
    climatology = mean(temp_ref; dims=3)
    temp_anom = temp .- climatology

    #reshape to 2D
    temp_anom = reshape(temp_anom, n_lon * n_lat, n_t)

    #stripping units
    return ustrip.(u"K", temp_anom)
end
```

```{julia}
#output: false
n_lon,n_lat,n_t =size(temp)
temp_mat_train = preprocess(temp_train, temp_train)
temp_mat_test = preprocess(temp_test, temp_train)
```

# 5. Principal Components
## 5.1 Fitting
```{julia}
pca_model = fit(PCA, temp_mat_train; maxoutdim=20, pratio=0.99);
pca_model
```
```{julia}
p1 = plot(principalvars(pca_model)/var(pca_model); xlabel="# of PC's", ylabel= "Fraction of Variance Explained", label = false, title= "Variance Explained")

p2 = plot(cumsum(principalvars(pca_model))/var(pca_model); xlabel="# of PC's", ylabel= "Fraction of Variance Explained", label = false, title= "Cumulative Variance Explained")

plot(p1,p2; layout(1,2), size=(800,400))
```
